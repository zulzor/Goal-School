# Мониторинг и логирование

## Логирование

### Уровни логирования

1. **Error** - ошибки, которые требуют немедленного внимания
2. **Warn** - предупреждения, которые могут указывать на проблемы
3. **Info** - информационные сообщения о нормальной работе
4. **Debug** - отладочная информация для разработчиков

### Формат логов

Логи содержат следующую информацию:

- Временная метка
- Уровень логирования
- Имя сервиса или компонента
- Сообщение
- Дополнительные данные (при наличии)

### Примеры логов

```
[2023-01-01T10:00:00.000Z] INFO [UserService] User logged in: user@example.com
[2023-01-01T10:05:00.000Z] WARN [DatabaseService] Slow query detected: 1500ms
[2023-01-01T10:10:00.000Z] ERROR [AuthService] Login failed: Invalid credentials
```

### Логирование в разных окружениях

#### Development

- Все уровни логирования выводятся в консоль
- Формат: читаемый для разработчиков

#### Production

- Только Error и Warn уровни записываются в файлы
- Формат: структурированный для автоматической обработки
- Логи ротируются ежедневно

## Мониторинг производительности

### Время отклика API

Мониторятся следующие метрики:

- Среднее время отклика
- 95-й процентиль времени отклика
- Количество запросов в секунду

### Использование ресурсов

#### Сервер

- CPU usage
- Memory usage
- Disk I/O
- Network I/O

#### База данных

- Количество активных соединений
- Время выполнения запросов
- Использование памяти

### Кэширование

#### Уровень приложения

- Hit rate кэша
- Размер кэша
- Время жизни записей в кэше

#### Уровень базы данных

- Cache hit ratio
- Buffer pool usage

## Мониторинг ошибок

### Типы отслеживаемых ошибок

1. **Ошибки базы данных**
   - Connection failures
   - Query timeouts
   - Deadlocks

2. **Ошибки приложения**
   - Unhandled exceptions
   - Validation errors
   - Authentication failures

3. **Ошибки сети**
   - Timeout errors
   - Connection failures
   - DNS resolution failures

### Уведомления об ошибках

#### Критические ошибки

- Немедленные уведомления по email/SMS
- Создание инцидента в системе мониторинга

#### Предупреждения

- Уведомления с задержкой (15 минут)
- Агрегация похожих предупреждений

## Инструменты мониторинга

### Локальная разработка

#### Консоль

- Логи выводятся в стандартный вывод
- Цветовое кодирование по уровням логирования

#### Docker

- Логи контейнеров доступны через `docker logs`
- Мониторинг ресурсов через `docker stats`

### Production

#### Логирование

- Использование централизованного логирования (ELK stack, Splunk)
- Ротация логов
- Архивирование логов

#### Метрики

- Prometheus для сбора метрик
- Grafana для визуализации
- Alertmanager для уведомлений

#### Трассировка

- OpenTelemetry для распределенной трассировки
- Jaeger или Zipkin для визуализации трасс

## Health Checks

### Liveness Probe

Проверяет, что приложение запущено и отвечает:

```
GET /api/health
```

Ответ:

```json
{
  "status": "OK",
  "timestamp": "2023-01-01T10:00:00.000Z",
  "version": "1.0.0"
}
```

### Readiness Probe

Проверяет, что приложение готово к обработке запросов:

```
GET /api/ready
```

Ответ:

```json
{
  "status": "READY",
  "database": "OK",
  "cache": "OK",
  "dependencies": ["service1", "service2"]
}
```

## Алерты

### Критические алерты

1. **Падение приложения**
   - Триггер: 3 неудачных health check подряд
   - Уведомление: немедленно

2. **Недоступность базы данных**
   - Триггер: 50% ошибок подключения к БД
   - Уведомление: немедленно

3. **Высокая нагрузка**
   - Триггер: CPU > 90% на 5 минут
   - Уведомление: немедленно

### Предупреждения

1. **Медленные запросы**
   - Триггер: 95-й процентиль времени отклика > 1 секунда
   - Уведомление: ежечасно

2. **Низкий cache hit ratio**
   - Триггер: < 80% в течение 30 минут
   - Уведомление: ежедневно

3. **Низкий уровень свободного места на диске**
   - Триггер: < 10% свободного места
   - Уведомление: немедленно

## Решение常见ых проблем

### Высокое время отклика

1. Проверьте логи на наличие медленных запросов
2. Проанализируйте использование ресурсов
3. Оптимизируйте медленные запросы к базе данных
4. Проверьте кэширование

### Ошибки подключения к базе данных

1. Проверьте статус PostgreSQL сервера
2. Убедитесь, что параметры подключения корректны
3. Проверьте ограничения пула соединений
4. Мониторьте количество активных соединений

### Утечки памяти

1. Мониторьте использование памяти во времени
2. Используйте профилировщики памяти
3. Проверьте правильность освобождения ресурсов
4. Обновите зависимости, если есть известные проблемы с памятью

## Best Practices

### Логирование

- Не логгируйте чувствительные данные (пароли, токены)
- Используйте структурированное логирование
- Добавляйте контекст к логам (user ID, request ID)

### Мониторинг

- Мониторьте бизнес-метрики, а не только технические
- Устанавливайте реалистичные пороги для алертов
- Регулярно пересматривайте и обновляйте правила мониторинга

### Алерты

- Избегайте alert fatigue - настраивайте значимые алерты
- Используйте разные каналы для разных типов алертов
- Документируйте процедуры реагирования на алерты

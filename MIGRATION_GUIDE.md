# Руководство по миграции с локального хранилища на PostgreSQL

## Введение

Это руководство описывает процесс миграции данных приложения Goal School с локального хранилища (AsyncStorage) на облачную базу данных PostgreSQL.

## Подготовка к миграции

### 1. Настройка PostgreSQL

1. Установите и настройте PostgreSQL сервер
2. Создайте базу данных для приложения
3. Настройте переменные окружения в файле `.env`:
   ```env
   DATABASE_URL=postgresql://username:password@localhost:5432/goalschool
   DB_HOST=localhost
   DB_PORT=5432
   DB_NAME=goalschool
   DB_USER=your_username
   DB_PASSWORD=your_password
   ```

### 2. Инициализация базы данных

Выполните инициализацию базы данных:

```bash
npm run db:init
```

### 3. Проверка подключения

Проверьте подключение к базе данных:

```bash
npm run db:check
```

## Процесс миграции

### 1. Создание скрипта миграции

Создайте скрипт для переноса данных из локального хранилища в PostgreSQL. Пример скрипта:

``javascript
// scripts/migrate-data.js
const { PostgreSQLUserService } = require('../src/services/PostgreSQLUserService');
// Импортируйте другие сервисы по необходимости

async function migrateData() {
console.log('Starting data migration...');

try {
// Здесь будет код для переноса данных
// Это пример, реальная реализация зависит от структуры данных

    console.log('Data migration completed successfully!');

} catch (error) {
console.error('Data migration failed:', error);
process.exit(1);
}
}

migrateData();

````

### 2. Перенос пользователей

1. Получите всех пользователей из локального хранилища
2. Создайте соответствующие записи в PostgreSQL
3. Убедитесь, что пароли хешированы правильно

### 3. Перенос посещаемости

1. Получите данные о посещаемости из локального хранилища
2. Создайте соответствующие записи в таблице attendance PostgreSQL

### 4. Перенос прогресса учеников

1. Получите данные о прогрессе из локального хранилища
2. Создайте соответствующие записи в таблице progress PostgreSQL

### 5. Перенос других данных

Повторите процесс для других типов данных:
- Новости
- Расписание
- План питания
- Навыки
- Достижения

## Переключение приложения на PostgreSQL

### 1. Через интерфейс админ-панели

1. Войдите в приложение с учетной записью администратора
2. Перейдите в "Админ-панель" → "База данных"
3. Выберите "PostgreSQL" в качестве типа базы данных
4. Проверьте подключение с помощью кнопки "Проверить подключение"
5. Приложение автоматически начнет использовать PostgreSQL

### 2. Через переменные окружения

Установите переменную окружения:
```env
DATABASE_TYPE=postgresql
````

## Проверка миграции

### 1. Проверка данных

1. Убедитесь, что все данные успешно перенесены
2. Проверьте целостность данных
3. Убедитесь, что связи между таблицами работают правильно

### 2. Тестирование функциональности

1. Протестируйте вход в систему
2. Проверьте работу всех экранов приложения
3. Убедитесь, что новые данные сохраняются в PostgreSQL

### 3. Проверка производительности

1. Оцените время отклика приложения
2. Проверьте использование ресурсов сервера
3. Убедитесь, что приложение работает стабильно

## Откат миграции

Если возникнут проблемы, можно откатить миграцию:

### 1. Переключение обратно на локальное хранилище

1. В админ-панели выберите "Локальная база данных"
2. Приложение начнет использовать локальное хранилище

### 2. Восстановление из резервной копии

Если данные в локальном хранилище были потеряны:

1. Восстановите резервную копию локальных данных
2. Перезапустите приложение

## Рекомендации

### 1. Перед миграцией

- Создайте резервную копию локальных данных
- Создайте резервную копию базы данных PostgreSQL
- Уведомите пользователей о плановом техническом обслуживании
- Проведите тестовую миграцию в тестовой среде

### 2. Во время миграции

- Следите за процессом миграции
- Имейте план отката на случай сбоев
- Документируйте все шаги миграции

### 3. После миграции

- Проведите тестирование функциональности
- Мониторьте производительность приложения
- Соберите обратную связь от пользователей

## Решение常见ых проблем

### Ошибка "Data migration failed"

1. Проверьте логи миграции
2. Убедитесь, что PostgreSQL сервер доступен
3. Проверьте параметры подключения к базе данных

### Ошибка "Duplicate key value violates unique constraint"

1. Проверьте, что данные не дублируются
2. Очистите таблицы перед миграцией, если это тестовая среда

### Проблемы с производительностью

1. Миграция больших объемов данных может занять время
2. Рассмотрите возможность поэтапной миграции
3. Используйте индексы в таблицах PostgreSQL для улучшения производительности

## Поддержка

Если у вас возникнут вопросы или проблемы с миграцией, обратитесь к документации или свяжитесь с разработчиками.

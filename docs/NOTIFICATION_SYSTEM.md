# Система уведомлений

## 1. Обзор системы

Система уведомлений предназначена для информирования пользователей о важных событиях в приложении футбольной школы "Арсенал". Система поддерживает несколько каналов доставки уведомлений и учитывает роли пользователей и их привязку к филиалам.

## 2. Архитектура системы

### 2.1. Компоненты системы

```
Notification System
├── Notification Service
├── Notification Types
├── Delivery Channels
├── User Preferences
└── History Storage
```

### 2.2. Сервис уведомлений

**Назначение:** Центральный компонент для создания, управления и доставки уведомлений.

**Функции:**

- Создание уведомлений
- Фильтрация уведомлений по ролям и филиалам
- Доставка уведомлений через различные каналы
- Хранение истории уведомлений
- Управление настройками уведомлений

### 2.3. Типы уведомлений

**Классификация:**

- По приоритету: высокий, средний, низкий
- По категории: посещаемость, новости, расписание, прогресс, система
- По адресату: индивидуальные, групповые, массовые

### 2.4. Каналы доставки

**Поддерживаемые каналы:**

- Push-уведомления
- Email-уведомления
- Внутренние уведомления в приложении

### 2.5. Настройки пользователя

**Назначение:** Позволяет пользователям настраивать получение уведомлений.

**Возможности:**

- Включение/выключение уведомлений
- Выбор каналов доставки
- Настройка времени "тишины"
- Настройка по категориям

### 2.6. Хранилище истории

**Назначение:** Хранит историю отправленных уведомлений.

**Функции:**

- Хранение уведомлений
- Поиск и фильтрация
- Пометка как прочитанных
- Удаление старых уведомлений

## 3. Типы уведомлений

### 3.1. Уведомления о посещаемости

#### 3.1.1. Для родителей

**События:**

- Ребенок пропустил тренировку
- Ребенок опоздал на тренировку
- Хорошая посещаемость ребенка

**Формат:**

```
Заголовок: Посещаемость [Имя ребенка]
Текст: [Имя ребенка] [пропустил/опоздал] на тренировку [Название тренировки]
Время: [Дата и время]
```

#### 3.1.2. Для управляющих

**События:**

- Низкая посещаемость в филиале
- Высокая посещаемость в филиале
- Проблемы с посещаемостью конкретных групп

**Формат:**

```
Заголовок: Посещаемость в [Название филиала]
Текст: [Описание ситуации с посещаемостью]
Время: [Дата и время]
```

### 3.2. Уведомления о новостях

#### 3.2.1. Для всех пользователей

**События:**

- Публикация важной новости
- Публикация новости в выбранной категории

**Формат:**

```
Заголовок: Новость: [Заголовок новости]
Текст: [Анонс новости]
Время: [Дата и время]
```

### 3.3. Уведомления о расписании

#### 3.3.1. Для родителей и детей

**События:**

- Изменение расписания тренировок
- Перенос тренировки
- Отмена тренировки

**Формат:**

```
Заголовок: Расписание: [Название тренировки]
Текст: [Описание изменений в расписании]
Время: [Дата и время]
```

#### 3.3.2. Для тренеров

**События:**

- Новые регистрации на тренировки
- Отмена регистраций на тренировки

**Формат:**

```
Заголовок: Регистрации: [Название тренировки]
Текст: [Описание изменений в регистрациях]
Время: [Дата и время]
```

### 3.4. Уведомления о прогрессе

#### 3.4.1. Для родителей

**События:**

- Достижение ребенком нового уровня навыка
- Получение нового достижения ребенком
- Рекомендации по улучшению навыков ребенка

**Формат:**

```
Заголовок: Прогресс [Имя ребенка]
Текст: [Имя ребенка] [достиг/получил] [описание достижения]
Время: [Дата и время]
```

#### 3.4.2. Для тренеров

**События:**

- Быстрый прогресс ученика
- Застой в прогрессе ученика
- Необходимость индивидуальной работы с учеником

**Формат:**

```
Заголовок: Прогресс ученика
Текст: [Имя ученика] [достиг/требует] [описание ситуации]
Время: [Дата и время]
```

### 3.5. Системные уведомления

#### 3.5.1. Для управляющих

**События:**

- Проблемы с базой данных
- Высокая нагрузка на систему
- Новые регистрации пользователей
- Подозрительная активность

**Формат:**

```
Заголовок: Система: [Тип события]
Текст: [Описание системного события]
Время: [Дата и время]
```

#### 3.5.2. Для всех пользователей

**События:**

- Технические работы
- Обновления приложения
- Проблемы с подключением

**Формат:**

```
Заголовок: Система: [Тип события]
Текст: [Описание системного события]
Время: [Дата и время]
```

## 4. Каналы доставки

### 4.1. Push-уведомления

**Платформы:**

- iOS (APNs)
- Android (FCM)
- Веб (Web Push API)

**Требования:**

- Поддержка фоновой доставки
- Обработка ошибок доставки
- Логирование статуса доставки

**Формат:**

```json
{
  "title": "Заголовок уведомления",
  "body": "Текст уведомления",
  "data": {
    "notificationId": "id уведомления",
    "type": "тип уведомления",
    "targetScreen": "целевой экран"
  }
}
```

### 4.2. Email-уведомления

**Провайдеры:**

- SMTP сервер
- Внешние сервисы (SendGrid, Mailgun и т.д.)

**Требования:**

- Шаблоны писем
- Поддержка HTML и текстовых писем
- Обработка ошибок отправки
- Логирование статуса отправки

**Формат:**

```
Тема: [Заголовок уведомления]
Текст: [Текст уведомления]
```

### 4.3. Внутренние уведомления

**Хранение:**

- База данных
- Локальное хранилище (для оффлайн режима)

**Формат:**

```json
{
  "id": "уникальный идентификатор",
  "userId": "идентификатор пользователя",
  "title": "заголовок",
  "message": "текст уведомления",
  "type": "тип уведомления",
  "priority": "приоритет",
  "createdAt": "дата создания",
  "read": "признак прочтения",
  "data": "дополнительные данные"
}
```

## 5. Приоритеты уведомлений

### 5.1. Высокий приоритет

**Характеристики:**

- Немедленная доставка
- Все каналы доставки
- Звуковые уведомления
- Вибрация (для мобильных устройств)

**Примеры:**

- Чрезвычайные ситуации
- Проблемы безопасности
- Критические технические проблемы

### 5.2. Средний приоритет

**Характеристики:**

- Быстрая доставка
- Основные каналы доставки
- Визуальные уведомления

**Примеры:**

- Уведомления о посещаемости
- Уведомления о прогрессе
- Уведомления о новостях

### 5.3. Низкий приоритет

**Характеристики:**

- Отложенная доставка
- Основные каналы доставки
- Минимальные визуальные эффекты

**Примеры:**

- Рекомендации по питанию
- Достижения
- Обновления контента

## 6. Настройки уведомлений

### 6.1. Глобальные настройки

**Параметры:**

- Включение/выключение всех уведомлений
- Выбор каналов доставки
- Установка времени "тишины"

**Интерфейс:**

- Переключатели для включения/выключения
- Выпадающие списки для выбора каналов
- Выбор времени в формате "с ... до ..."

### 6.2. Настройки по категориям

**Категории:**

- Посещаемость
- Новости
- Расписание
- Прогресс
- Система

**Параметры:**

- Включение/выключение категории
- Выбор каналов для категории
- Установка приоритета категории

### 6.3. Настройки по филиалам

**Параметры:**

- Выбор филиалов для получения уведомлений
- Настройка разных параметров для разных филиалов

## 7. API системы уведомлений

### 7.1. Создание уведомлений

**Endpoint:** `POST /api/notifications`

**Параметры:**

```json
{
  "title": "заголовок",
  "message": "текст уведомления",
  "type": "тип уведомления",
  "priority": "приоритет",
  "target": {
    "users": ["список пользователей"],
    "roles": ["список ролей"],
    "branches": ["список филиалов"]
  },
  "channels": ["список каналов"],
  "data": "дополнительные данные"
}
```

**Ответ:**

```json
{
  "success": true,
  "notificationId": "идентификатор уведомления"
}
```

### 7.2. Получение уведомлений пользователя

**Endpoint:** `GET /api/notifications`

**Параметры:**

- `limit` - количество уведомлений
- `offset` - смещение
- `read` - фильтр по прочтению
- `type` - фильтр по типу

**Ответ:**

```json
{
  "notifications": [
    {
      "id": "идентификатор",
      "title": "заголовок",
      "message": "текст",
      "type": "тип",
      "priority": "приоритет",
      "createdAt": "дата создания",
      "read": "признак прочтения"
    }
  ]
}
```

### 7.3. Пометка уведомлений как прочитанных

**Endpoint:** `PUT /api/notifications/{id}/read`

**Ответ:**

```json
{
  "success": true
}
```

### 7.4. Удаление уведомлений

**Endpoint:** `DELETE /api/notifications/{id}`

**Ответ:**

```json
{
  "success": true
}
```

## 8. База данных

### 8.1. Таблица уведомлений

```sql
CREATE TABLE notifications (
  id SERIAL PRIMARY KEY,
  title VARCHAR(255) NOT NULL,
  message TEXT NOT NULL,
  type VARCHAR(50) NOT NULL,
  priority VARCHAR(20) NOT NULL,
  target_users JSONB,
  target_roles JSONB,
  target_branches JSONB,
  channels JSONB,
  data JSONB,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

### 8.2. Таблица пользовательских уведомлений

```sql
CREATE TABLE user_notifications (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id),
  notification_id INTEGER REFERENCES notifications(id),
  read BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT NOW(),
  read_at TIMESTAMP
);
```

### 8.3. Таблица настроек уведомлений

```sql
CREATE TABLE notification_settings (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id) UNIQUE,
  enabled BOOLEAN DEFAULT TRUE,
  channels JSONB,
  quiet_hours_start TIME,
  quiet_hours_end TIME,
  category_settings JSONB,
  branch_settings JSONB,
  updated_at TIMESTAMP DEFAULT NOW()
);
```

## 9. Безопасность

### 9.1. Аутентификация

Все API endpoints системы уведомлений должны быть защищены JWT токенами.

### 9.2. Авторизация

**Права доступа:**

- Обычные пользователи: получение, чтение, удаление своих уведомлений
- Управляющие: создание уведомлений для других пользователей
- Администраторы: полный доступ к системе

### 9.3. Защита данных

**Меры:**

- Шифрование персональных данных
- Логирование всех операций
- Ограничение количества уведомлений, которые могут быть отправлены

## 10. Мониторинг и аналитика

### 10.1. Отслеживание эффективности

**Метрики:**

- Процент доставки уведомлений
- Процент открытия уведомлений
- Время доставки уведомлений
- Количество ошибок доставки

### 10.2. Аналитика

**Отчеты:**

- По категориям уведомлений
- По каналам доставки
- По филиалам
- По ролям пользователей

### 10.3. Логирование

**События для логирования:**

- Создание уведомлений
- Попытки доставки
- Успешная доставка
- Ошибки доставки
- Чтение уведомлений пользователями

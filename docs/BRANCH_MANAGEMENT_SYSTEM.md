# Система управления филиалами

## 1. Обзор системы

Система управления филиалами предназначена для администрирования филиалов футбольной школы "Арсенал". Система позволяет управляющим создавать, редактировать, удалять филиалы, а также назначать тренеров филиалам.

## 2. Архитектура системы

### 2.1. Компоненты системы

```
Branch Management System
├── Branch Service
├── Branch Repository
├── Branch Controller
├── Coach Assignment Service
└── Validation Service
```

### 2.2. Сервис филиалов

**Назначение:** Основной сервис для работы с филиалами.

**Функции:**

- Создание филиалов
- Получение списка филиалов
- Получение информации о филиале
- Обновление информации о филиале
- Удаление филиалов

### 2.3. Репозиторий филиалов

**Назначение:** Слой доступа к данным филиалов.

**Функции:**

- Выполнение CRUD операций с филиалами в базе данных
- Выполнение сложных запросов (фильтрация, сортировка, пагинация)
- Обработка транзакций

### 2.4. Контроллер филиалов

**Назначение:** Обработка HTTP запросов, связанных с филиалами.

**Функции:**

- Обработка REST API endpoints
- Валидация входных данных
- Преобразование данных между слоями
- Обработка ошибок

### 2.5. Сервис назначения тренеров

**Назначение:** Управление назначением тренеров филиалам.

**Функции:**

- Назначение тренеров филиалам
- Отмена назначения тренеров
- Получение списка тренеров филиала
- Проверка прав доступа

### 2.6. Сервис валидации

**Назначение:** Проверка корректности данных.

**Функции:**

- Валидация данных филиалов
- Проверка уникальности названий
- Проверка существования филиалов
- Проверка существования пользователей

## 3. Модель данных

### 3.1. Таблица филиалов

```sql
CREATE TABLE branches (
  id SERIAL PRIMARY KEY,
  name VARCHAR(255) NOT NULL UNIQUE,
  address TEXT,
  phone VARCHAR(50),
  email VARCHAR(255),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

**Поля:**

- `id` - Уникальный идентификатор филиала
- `name` - Название филиала (уникальное)
- `address` - Адрес филиала
- `phone` - Телефон филиала
- `email` - Email филиала
- `created_at` - Дата создания
- `updated_at` - Дата последнего обновления

### 3.2. Таблица назначений тренеров

```sql
CREATE TABLE coach_branches (
  id SERIAL PRIMARY KEY,
  coach_id INTEGER REFERENCES users(id),
  branch_id INTEGER REFERENCES branches(id),
  assigned_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(coach_id, branch_id)
);
```

**Поля:**

- `id` - Уникальный идентификатор назначения
- `coach_id` - Идентификатор тренера
- `branch_id` - Идентификатор филиала
- `assigned_at` - Дата назначения
- Уникальное ограничение на пару (coach_id, branch_id)

### 3.3. Изменения в таблице пользователей

```sql
ALTER TABLE users
ADD COLUMN branch_id INTEGER REFERENCES branches(id);
```

**Поле:**

- `branch_id` - Идентификатор филиала, к которому привязан пользователь

## 4. API системы

### 4.1. Получение списка филиалов

**Endpoint:** `GET /api/branches`

**Параметры запроса:**

- `limit` - Количество филиалов на странице (по умолчанию 10)
- `offset` - Смещение (по умолчанию 0)
- `search` - Поиск по названию филиала
- `sort` - Поле для сортировки (name, created_at)
- `order` - Порядок сортировки (asc, desc)

**Ответ:**

```json
{
  "branches": [
    {
      "id": 1,
      "name": "Футбольная школа Арсенал Жулебино",
      "address": "г. Москва, ул. Лухмановская, д. 3",
      "phone": "+7 (495) 123-45-67",
      "email": "zhulebino@arsenal-school.ru",
      "created_at": "2023-01-15T10:30:00Z",
      "updated_at": "2023-01-15T10:30:00Z"
    }
  ],
  "total": 1,
  "limit": 10,
  "offset": 0
}
```

### 4.2. Получение информации о филиале

**Endpoint:** `GET /api/branches/{id}`

**Параметры пути:**

- `id` - Идентификатор филиала

**Ответ:**

```json
{
  "id": 1,
  "name": "Футбольная школа Арсенал Жулебино",
  "address": "г. Москва, ул. Лухмановская, д. 3",
  "phone": "+7 (495) 123-45-67",
  "email": "zhulebino@arsenal-school.ru",
  "created_at": "2023-01-15T10:30:00Z",
  "updated_at": "2023-01-15T10:30:00Z"
}
```

**Ошибки:**

- 404 - Филиал не найден

### 4.3. Создание филиала

**Endpoint:** `POST /api/branches`

**Тело запроса:**

```json
{
  "name": "Футбольная школа Арсенал Дмитриевское",
  "address": "г. Москва, ул. Дмитриевская, д. 15",
  "phone": "+7 (495) 987-65-43",
  "email": "dmitrievskoe@arsenal-school.ru"
}
```

**Ответ:**

```json
{
  "id": 2,
  "name": "Футбольная школа Арсенал Дмитриевское",
  "address": "г. Москва, ул. Дмитриевская, д. 15",
  "phone": "+7 (495) 987-65-43",
  "email": "dmitrievskoe@arsenal-school.ru",
  "created_at": "2023-02-20T14:15:00Z",
  "updated_at": "2023-02-20T14:15:00Z"
}
```

**Ошибки:**

- 400 - Некорректные данные
- 409 - Филиал с таким названием уже существует

### 4.4. Обновление информации о филиале

**Endpoint:** `PUT /api/branches/{id}`

**Параметры пути:**

- `id` - Идентификатор филиала

**Тело запроса:**

```json
{
  "name": "Футбольная школа Арсенал Дмитриевское (обновлено)",
  "address": "г. Москва, ул. Дмитриевская, д. 15, стр. 2",
  "phone": "+7 (495) 987-65-44",
  "email": "dmitrievskoe-new@arsenal-school.ru"
}
```

**Ответ:**

```json
{
  "id": 2,
  "name": "Футбольная школа Арсенал Дмитриевское (обновлено)",
  "address": "г. Москва, ул. Дмитриевская, д. 15, стр. 2",
  "phone": "+7 (495) 987-65-44",
  "email": "dmitrievskoe-new@arsenal-school.ru",
  "created_at": "2023-02-20T14:15:00Z",
  "updated_at": "2023-02-21T16:45:00Z"
}
```

**Ошибки:**

- 400 - Некорректные данные
- 404 - Филиал не найден
- 409 - Филиал с таким названием уже существует

### 4.5. Удаление филиала

**Endpoint:** `DELETE /api/branches/{id}`

**Параметры пути:**

- `id` - Идентификатор филиала

**Ответ:**

```json
{
  "success": true,
  "message": "Филиал успешно удален"
}
```

**Ошибки:**

- 404 - Филиал не найден
- 409 - Невозможно удалить филиал, так как он используется

### 4.6. Назначение тренера филиалу

**Endpoint:** `POST /api/branches/{branchId}/coaches`

**Параметры пути:**

- `branchId` - Идентификатор филиала

**Тело запроса:**

```json
{
  "coachId": 123
}
```

**Ответ:**

```json
{
  "success": true,
  "message": "Тренер успешно назначен филиалу"
}
```

**Ошибки:**

- 400 - Некорректные данные
- 404 - Филиал или тренер не найден
- 409 - Тренер уже назначен этому филиалу

### 4.7. Отмена назначения тренера

**Endpoint:** `DELETE /api/branches/{branchId}/coaches/{coachId}`

**Параметры пути:**

- `branchId` - Идентификатор филиала
- `coachId` - Идентификатор тренера

**Ответ:**

```json
{
  "success": true,
  "message": "Назначение тренера отменено"
}
```

**Ошибки:**

- 404 - Филиал или тренер не найден
- 409 - Тренер не назначен этому филиалу

### 4.8. Получение списка тренеров филиала

**Endpoint:** `GET /api/branches/{id}/coaches`

**Параметры пути:**

- `id` - Идентификатор филиала

**Ответ:**

```json
{
  "coaches": [
    {
      "id": 123,
      "name": "Иванов Иван Иванович",
      "email": "ivanov@example.com",
      "assigned_at": "2023-02-21T16:45:00Z"
    }
  ]
}
```

**Ошибки:**

- 404 - Филиал не найден

## 5. Валидация данных

### 5.1. Валидация филиала

**Правила:**

- Название филиала обязательно
- Название филиала должно быть уникальным
- Email должен быть в корректном формате (если указан)
- Телефон должен быть в корректном формате (если указан)

### 5.2. Валидация назначения тренера

**Правила:**

- Тренер должен существовать
- Филиал должен существовать
- Тренер должен иметь роль "coach"
- Тренер не должен быть уже назначен этому филиалу

## 6. Безопасность

### 6.1. Аутентификация

Все API endpoints системы управления филиалами должны быть защищены JWT токенами.

### 6.2. Авторизация

**Права доступа:**

- Только пользователи с ролью "manager" могут:
  - Создавать филиалы
  - Редактировать филиалы
  - Удалять филиалы
  - Назначать тренеров филиалам
  - Отменять назначение тренеров

- Все авторизованные пользователи могут:
  - Получать список филиалов
  - Получать информацию о филиале
  - Получать список тренеров филиала

### 6.3. Защита данных

**Меры:**

- Логирование всех операций с филиалами
- Ограничение количества запросов
- Валидация всех входных данных
- Защита от SQL-инъекций

## 7. Интерфейс пользователя

### 7.1. Экран управления филиалами

**Назначение:** Центральный экран для управления филиалами.

**Элементы интерфейса:**

- Список филиалов с возможностью поиска и фильтрации
- Кнопка создания нового филиала
- Кнопки редактирования и удаления для каждого филиала
- Индикатор загрузки
- Сообщения об ошибках

**Функциональность:**

- Отображение списка филиалов
- Поиск филиалов по названию
- Переход к экрану создания филиала
- Переход к экрану редактирования филиала
- Удаление филиала с подтверждением

### 7.2. Форма создания/редактирования филиала

**Назначение:** Форма для создания и редактирования информации о филиале.

**Элементы интерфейса:**

- Поле ввода названия филиала
- Поле ввода адреса филиала
- Поле ввода телефона филиала
- Поле ввода email филиала
- Кнопки сохранения и отмены
- Индикатор загрузки
- Сообщения об ошибках

**Функциональность:**

- Валидация всех полей
- Сохранение данных филиала
- Отмена операции
- Отображение ошибок валидации

### 7.3. Модальное окно подтверждения удаления

**Назначение:** Подтверждение удаления филиала.

**Элементы интерфейса:**

- Сообщение с вопросом о подтверждении удаления
- Кнопки подтверждения и отмены

**Функциональность:**

- Подтверждение удаления филиала
- Отмена операции удаления

### 7.4. Экран назначения тренеров

**Назначение:** Управление назначением тренеров филиалам.

**Элементы интерфейса:**

- Список тренеров, назначенных филиалу
- Возможность поиска тренеров для назначения
- Кнопка назначения тренера
- Кнопки отмены назначения для каждого тренера
- Индикатор загрузки
- Сообщения об ошибках

**Функциональность:**

- Отображение списка назначенных тренеров
- Поиск тренеров для назначения
- Назначение тренера филиалу
- Отмена назначения тренера

## 8. Интеграция с другими системами

### 8.1. Интеграция с системой пользователей

**Связи:**

- Каждый пользователь может быть привязан к филиалу
- Тренеры могут быть назначены филиалам
- При удалении филиала обновляется информация о пользователях

### 8.2. Интеграция с системой тренировок

**Связи:**

- Каждая тренировка привязана к филиалу
- Тренеры могут создавать тренировки только для своего филиала
- При удалении филиала удаляются все тренировки филиала

### 8.3. Интеграция с системой уведомлений

**Связи:**

- Уведомления могут быть адресованы пользователям определенного филиала
- Системные уведомления для управляющих о событиях с филиалами

## 9. Тестирование

### 9.1. Модульное тестирование

**Компоненты для тестирования:**

- Сервис филиалов
- Репозиторий филиалов
- Контроллер филиалов
- Сервис назначения тренеров
- Сервис валидации

### 9.2. Интеграционное тестирование

**Сценарии:**

- Создание, получение, обновление и удаление филиалов
- Назначение и отмена назначения тренеров
- Фильтрация и сортировка филиалов
- Обработка ошибок

### 9.3. Приемочное тестирование

**Сценарии:**

- Управляющий создает новый филиал
- Управляющий редактирует информацию о филиале
- Управляющий удаляет филиал
- Управляющий назначает тренера филиалу
- Управляющий отменяет назначение тренера
- Пользователи просматривают список филиалов

## 10. Мониторинг и логирование

### 10.1. Логирование операций

**События для логирования:**

- Создание филиала
- Обновление информации о филиале
- Удаление филиала
- Назначение тренера филиалу
- Отмена назначения тренера
- Ошибки при выполнении операций

### 10.2. Метрики

**Метрики для отслеживания:**

- Количество филиалов
- Количество тренеров, назначенных филиалам
- Частота операций с филиалами
- Время выполнения операций
- Количество ошибок

### 10.3. Алерты

**Условия для алертов:**

- Попытки несанкционированного доступа
- Ошибки при создании/обновлении филиалов
- Попытки удаления филиалов с активными тренировками
- Высокая частота операций (возможная атака)

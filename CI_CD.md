# Непрерывная интеграция и развертывание (CI/CD)

## Описание

Это руководство описывает, как настроить и использовать CI/CD пайплайн для приложения футбольной школы с использованием GitHub Actions.

## Архитектура CI/CD

### Основные компоненты

1. **Тестирование** - автоматическое тестирование кода
2. **Сборка** - создание production сборки приложения
3. **Развертывание** - автоматическое развертывание на продакшен

### Поддерживаемые ветки

- **main** - основная ветка, развертывается в продакшен
- **develop** - ветка разработки, используется для тестирования

## GitHub Actions Workflow

### Файл конфигурации

`.github/workflows/ci.yml` - основной файл CI/CD пайплайна

### Задачи пайплайна

#### 1. Тестирование (test)

**Триггеры:**

- Push в ветки `main` и `develop`
- Создание Pull Request в ветку `main`

**Шаги:**

1. Установка Node.js и зависимостей
2. Запуск PostgreSQL в Docker контейнере
3. Проверка конфигурации окружения
4. Инициализация тестовой базы данных
5. Запуск unit-тестов
6. Проверка покрытия кода тестами

#### 2. Сборка (build)

**Триггеры:**

- Успешное выполнение задачи тестирования

**Шаги:**

1. Установка Node.js и зависимостей
2. Создание production сборки веб-приложения
3. Архивирование сборки как артефакта

#### 3. Развертывание (deploy)

**Триггеры:**

- Успешное выполнение задачи сборки
- Только для ветки `main`

**Шаги:**

1. Загрузка артефакта сборки
2. Развертывание на Vercel

## Настройка CI/CD

### 1. Создание репозитория

1. Создайте репозиторий на GitHub
2. Добавьте файлы приложения в репозиторий
3. Убедитесь, что файл `.github/workflows/ci.yml` находится в репозитории

### 2. Настройка секретов

В настройках репозитория (Settings → Secrets) добавьте следующие секреты:

#### Для развертывания на Vercel:

- `VERCEL_TOKEN` - токен доступа к Vercel
- `VERCEL_ORG_ID` - ID организации в Vercel
- `VERCEL_PROJECT_ID` - ID проекта в Vercel

#### Для развертывания на другие платформы:

- `DEPLOY_KEY` - SSH ключ для развертывания
- `DEPLOY_HOST` - хост для развертывания
- `DEPLOY_USER` - пользователь для развертывания

### 3. Настройка веток

1. Установите ветку `main` как основную
2. Защитите ветку `main` от прямых push (только через Pull Request)
3. Настройте обязательные проверки статуса перед слиянием

## Тестирование в CI/CD

### Автоматическое тестирование

Пайплайн автоматически запускает все тесты при каждом push:

```bash
npm test
```

### Покрытие кода

Проверяется покрытие кода тестами:

```bash
npm run test:coverage
```

### Тестовая база данных

Для тестов автоматически создается изолированная PostgreSQL база данных:

- **База данных:** goalschool_test
- **Пользователь:** test_user
- **Пароль:** test_password
- **Порт:** 5432

## Сборка приложения

### Production сборка

Создается оптимизированная сборка для продакшена:

```bash
npm run build
```

### Артефакты сборки

Сборка архивируется и сохраняется как артефакт GitHub Actions:

- **Имя:** web-build
- **Содержимое:** директория `web-build/`

## Развертывание

### Развертывание на Vercel

Для развертывания на Vercel используется действие `amondnet/vercel-action`.

#### Настройка Vercel:

1. Создайте аккаунт на [Vercel](https://vercel.com)
2. Создайте проект
3. Получите токен доступа в настройках аккаунта
4. Получите ID организации и проекта

### Развертывание на другие платформы

Для развертывания на другие платформы можно использовать SSH:

```
- name: Развертывание через SSH
  uses: appleboy/ssh-action@v0.1.5
  with:
    host: ${{ secrets.DEPLOY_HOST }}
    username: ${{ secrets.DEPLOY_USER }}
    key: ${{ secrets.DEPLOY_KEY }}
    script: |
      cd /path/to/app
      # Команды для развертывания
```

## Мониторинг и уведомления

### Уведомления о сборках

GitHub автоматически отправляет уведомления о статусе сборок:

- В Pull Requests
- В коммиты
- Через вебхуки

### Интеграция с Slack

Для интеграции с Slack добавьте в workflow:

```
- name: Уведомление в Slack
  uses: 8398a7/action-slack@v3
  with:
    status: ${{ job.status }}
    channel: '#ci-cd'
  env:
    SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
```

## Устранение неполадок

### Ошибка тестов

1. Проверьте логи выполнения тестов
2. Убедитесь, что тестовая база данных настроена правильно
3. Проверьте переменные окружения в workflow

### Ошибка сборки

1. Проверьте логи сборки
2. Убедитесь, что все зависимости установлены
3. Проверьте конфигурацию сборки

### Ошибка развертывания

1. Проверьте логи развертывания
2. Убедитесь, что секреты настроены правильно
3. Проверьте доступ к целевой платформе

## Рекомендации

### Для разработчиков

1. Всегда тестируйте изменения локально перед push
2. Пишите unit-тесты для нового функционала
3. Следите за статусом CI/CD пайплайна
4. Используйте Pull Requests для код-ревью

### Для администраторов

1. Регулярно обновляйте секреты и токены
2. Мониторьте использование ресурсов в CI/CD
3. Настройте резервное копирование для продакшена
4. Имейте план отката при сбоях развертывания

## Расширение пайплайна

### Добавление линтинга кода

```
- name: Линтинг кода
  run: npm run lint
```

### Добавление анализа безопасности

```
- name: Анализ безопасности
  uses: snyk/actions/node@master
  env:
    SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
```

### Добавление автоматического создания релизов

```
- name: Создание релиза
  uses: actions/create-release@v1
  env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  with:
    tag_name: v${{ github.run_number }}
    release_name: Release ${{ github.run_number }}
```

## Поддержка

Если у вас возникли проблемы с настройкой CI/CD, обратитесь к документации GitHub Actions или создайте issue в репозитории проекта.

# CI/CD Pipeline

## Описание

Проект использует GitHub Actions для непрерывной интеграции и доставки.

## Файл конфигурации

[.github/workflows/ci.yml](.github/workflows/ci.yml) содержит конфигурацию CI/CD pipeline.

## Этапы pipeline

### 1. Test (Тестирование)

Запускается для всех push и pull request в ветки `main` и `develop`.

#### Задачи:

- Проверка кода
- Запуск unit тестов
- Запуск линтера
- Проверка переменных окружения

#### Сервисы:

- PostgreSQL 16.4 для тестовой базы данных

### 2. Build Web (Сборка веб-версии)

Запускается только для изменений в ветке `main` после успешного прохождения тестов.

#### Задачи:

- Сборка веб-версии приложения
- Сохранение артефактов сборки

### 3. Build Docker (Сборка Docker образа)

Запускается только для изменений в ветке `main` после успешного прохождения тестов.

#### Задачи:

- Сборка Docker образа
- Публикация образа в DockerHub

### 4. Deploy (Деплой)

Запускается только для изменений в ветке `main` после успешной сборки.

#### Задачи:

- Деплой приложения на сервер

## Переменные окружения в CI/CD

### Secrets (Секреты)

Следующие секреты должны быть настроены в GitHub repository settings:

| Секрет             | Описание                   |
| ------------------ | -------------------------- |
| DOCKERHUB_USERNAME | Имя пользователя DockerHub |
| DOCKERHUB_TOKEN    | Токен доступа к DockerHub  |

## Триггеры

### Push

Pipeline запускается при push в ветки:

- `main`
- `develop`

### Pull Request

Pipeline запускается при создании или обновлении pull request в ветки:

- `main`
- `develop`

## Артефакты

### Web Build

Собранные файлы веб-версии сохраняются как артефакты и могут быть скачаны из GitHub Actions.

### Docker Image

Docker образ публикуется в DockerHub с тегом `latest`.

## Мониторинг

### Статус pipeline

Статус последнего запуска отображается в виде бейджа в README.md.

### Логи

Логи выполнения всех этапов доступны в интерфейсе GitHub Actions.

## Решение常见ых проблем

### Ошибка тестов

1. Проверьте логи выполнения тестов
2. Убедитесь, что все зависимости установлены правильно
3. Проверьте переменные окружения

### Ошибка сборки Docker образа

1. Проверьте Dockerfile на наличие ошибок
2. Убедитесь, что все необходимые файлы включены в контекст сборки
3. Проверьте наличие секретов DockerHub

### Ошибка деплоя

1. Проверьте настройки деплоя
2. Убедитесь, что сервер доступен
3. Проверьте права доступа к серверу

## Расширение pipeline

### Добавление новых этапов

1. Отредактируйте [.github/workflows/ci.yml](.github/workflows/ci.yml)
2. Добавьте новые job или steps
3. Настройте необходимые переменные окружения

### Добавление новых триггеров

1. Отредактируйте секцию `on` в workflow файле
2. Добавьте новые ветки или события

### Добавление новых артефактов

1. Используйте `actions/upload-artifact` для сохранения файлов
2. Используйте `actions/download-artifact` для загрузки файлов в других job
